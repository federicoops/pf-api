<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactions Visualization</title>
    <link 
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" 
        rel="stylesheet">
    <link 
        href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" 
        rel="stylesheet">
    <style>
    /* Align all numeric cells to the right */
        .text-right {
            text-align: right;
        }


        body {
            margin: 0;
            padding: 0;
        }
        
    </style>
</head>
<body>
    <div id="content" class="container-fluid mt-5">
        <h1 class="mb-4">Dettaglio e pianificazione</h1>
        <div id="login-feedback" class="mt-3"></div>
        <a href="./"  class="btn btn-secondary show-after-login">Home</a>
        <hr>
        <div class="row">
            <!-- Planned Expenses Card -->
            <div class="col-lg-3">
                <div class="card mb-4">
                    <div class="card-body">
                        <form id="incomeForm" class="mb-4">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="plannedIncome" class="form-label">Prossimo stipendio</label>
                                    <input type="number" id="plannedIncome" class="form-control" placeholder="e.g., 3000" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">Salva</button>
                        </form>
    
                        <div class="alert alert-secondary" id="netSavings">
                            Risparmio questo mese: <b style="color:goldenrod" id="netSavingsAmount">0</b><br>
                            Spese questo mese: <b style="color:red"id="totalExpenses">0</b><br>

                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <form id="expenseForm" class="mb-4">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <input type="text" id="category" class="form-control" placeholder="Descrizione" required>
                                </div>
                                <div class="col-12 mb-3">
                                    <label for="amount" class="form-label">Importo</label>
                                    <input type="number" step="any" id="amount" class="form-control" placeholder="e.g., 100" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Aggiungi ricorrente</button>
                        </form>
    
                        <table class="table " id="plannedExpensesTable">
                            <thead>
                                <tr>
                                    <th>Categoria</th>
                                    <th>Importo</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Planned expenses will be dynamically populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
    
            <!-- Transactions Table -->
            <div class="col-lg-9">
                <table id="transactionsTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Gennaio</th>
                            <th>Febbraio</th>
                            <th>Marzo</th>
                            <th>Aprile</th>
                            <th>Maggio</th>
                            <th>Giugno</th>
                            <th>Luglio</th>
                            <th>Agosto</th>
                            <th>Settembre</th>
                            <th>Ottobre</th>
                            <th>Novembre</th>
                            <th>Dicembre</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be dynamically populated -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script 
    src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script 
    src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="apiclient.js"></script>
    <script src="index.js"></script>
<script>
    $(document).ready(async function () {
    await boot()
    $.transactionData = await $.apiClient.getOverview(2024)
 
    // Transform data into a pivot table format
    const pivotData = {};
    const monthlyTotals = Array(12).fill(0);
    $.transactionData.forEach(({ _id, total }) => {
        if(_id.category == "Trasferimento" || _id.category == "Investimento") return;
        if (!pivotData[_id.category]) pivotData[_id.category] = Array(12).fill(0);
        pivotData[_id.category][_id.month - 1] = total;
        
        // Update monthly totals
        monthlyTotals[_id.month - 1] += total;
    });

    // Add total row
    const tbody = $("#transactionsTable tbody");

    const totalRow = `<tr class="table-secondary">
        <td><strong>Totale</strong></td>
        ${monthlyTotals.map(total => `<td class="text-right"><strong>${total.toFixed(2)+" €"}</strong></td>`).join('')}
    </tr>`;
    tbody.append(totalRow);

    // Populate table rows
    Object.entries(pivotData).forEach(([category, months]) => {
        const row = `<tr>
            <td>${category}</td>
            ${months.map(amount => `<td class="text-right">${amount.toFixed(2)+" €" || 0}</td>`).join('')}
        </tr>`;
        tbody.append(row);
    });

    // Initialize DataTable
    $("#transactionsTable").DataTable({
        paging: false,
        searching: false,
        info: false,
        ordering: false
    });

    // Local Storage Keys
    const plannedExpensesKey = "plannedExpenses";
    const plannedIncomeKey = "plannedIncome";

    // Retrieve or initialize planned income and expenses from local storage
    const getPlannedExpenses = () => JSON.parse(localStorage.getItem(plannedExpensesKey)) || [];
    const savePlannedExpenses = (expenses) => localStorage.setItem(plannedExpensesKey, JSON.stringify(expenses));
    const getPlannedIncome = () => parseFloat(localStorage.getItem(plannedIncomeKey)) || 0;
    $("#plannedIncome").val(getPlannedIncome())
    const savePlannedIncome = (income) => localStorage.setItem(plannedIncomeKey, income);

    function isCurrentMonthExpense(transaction) {
        const currentMonth = new Date().getMonth() + 1; // Months are 0-indexed
        return (transaction['_id'].month === currentMonth) && 
            transaction.total < 0 && 
            !(transaction._id.category == "Trasferimento" || transaction._id.category == "Investimento")
    }

    // Function to get the total actual expenses for the current month
    const getActualExpensesForCurrentMonth = () => {
        const currentMonth = new Date().getMonth() + 1; // Months are 0-indexed
        return $.transactionData
            .filter(transaction => isCurrentMonthExpense(transaction))
            .reduce((sum, transaction) => sum + transaction.total, 0);
    };

    // Function to calculate and update net savings
    const updateNetSavings = () => {
        const plannedExpenses = getPlannedExpenses().filter(e => e.enabled).reduce((sum, expense) => sum + expense.amount, 0);
        const actualExpenses = getActualExpensesForCurrentMonth();
        const plannedIncome = getPlannedIncome();
        const totalExpenses = -(-plannedExpenses+actualExpenses)
        const netSavings = plannedIncome - (totalExpenses);
        $("#netSavingsAmount").text(netSavings.toFixed(2)+" €");
        $("#totalExpenses").text(totalExpenses.toFixed(2)+" €");

    };

    // Function to populate the planned expenses table
    const loadPlannedExpensesTable = () => {
        const tbody = $("#plannedExpensesTable tbody");
        tbody.empty(); // Clear existing rows
        const expenses = getPlannedExpenses();

        expenses.forEach((expense, index) => {
            const row = `<tr>
                <td>${expense.category}</td>
                <td class="text-right">${expense.amount.toFixed(2)+ " €"}</td>
                <td>
                    <button class="btn btn-danger btn-sm delete-expense" data-index="${index}">Delete</button>
                    <input class="form-check-input enable-recurrent" type="checkbox"  data-index="${index}" ${(expense.enabled)?'checked':''}>
                </td>
            </tr>`;
            tbody.append(row);
        });

        // Attach delete handlers
        $(".delete-expense").on("click", function () {
            const index = $(this).data("index");
            deletePlannedExpense(index);
            updateNetSavings();
        });

        // Attach delete handlers
        $(".enable-recurrent").on("click", function () {
            const index = $(this).data("index");
            
            const expenses = getPlannedExpenses()
            expenses[index].enabled = $(this).prop('checked')
            savePlannedExpenses(expenses);
            updateNetSavings();
        });

        // Update net savings
        updateNetSavings();
    };

    // Function to delete a planned expense by index
    const deletePlannedExpense = (index) => {
        const expenses = getPlannedExpenses();
        expenses.splice(index, 1);
        savePlannedExpenses(expenses);
        loadPlannedExpensesTable();
    };

    // Expense form submission handler
    $("#expenseForm").on("submit", function (e) {
        e.preventDefault();
        const category = $("#category").val();
        const amount = parseFloat($("#amount").val());

        const newExpense = { category, amount };
        const expenses = getPlannedExpenses();
        expenses.push(newExpense);
        savePlannedExpenses(expenses);

        // Reset form and refresh table
        this.reset();
        loadPlannedExpensesTable();
    });

    // Income form submission handler
    $("#incomeForm").on("submit", function (e) {
        e.preventDefault();
        const income = parseFloat($("#plannedIncome").val());

        savePlannedIncome(income);
        updateNetSavings();
    });

    // Load planned expenses and update net savings
    loadPlannedExpensesTable();
    updateNetSavings();
});
</script>
});

</script>
</body>
</html>
