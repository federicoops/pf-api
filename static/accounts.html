<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Accounts</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
/>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

</head>
<body>
  <div class="container mt-5">
    <h4>Gestione conti</h4>
    <div id="login-feedback" class="mt-3"></div>
    <div class="d-flex flex-column flex-md-row gap-2">
        <a href="/app/"  class="btn btn-light show-after-login">Home</a>
        <a href="/app/new.html"  class="btn btn-light show-after-login">Nuovo movimento</a>
        <a href="/app/transactions.html"  class="btn btn-light show-after-login">Tutti i movimenti</a>
        <a href="/app/expenses.html"  class="btn btn-light show-after-login">Dettaglio spese</a>
        <a href="/app/accounts.html"  class="btn btn-primary show-after-login">Conti</a>
    </div>
    <hr>
    <div class="mb-3">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAccountModal">Aggiungi conto</button>
    </div>
    <table id="accounts-page-table" class="table table-striped" style="width:100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>Conto</th>
                <th>Disponibile</th>
                <th>Tipo</th>
                <th>Azioni</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
  </div>

  <!-- Create Account Modal -->
  <div class="modal fade" id="createAccountModal" tabindex="-1" aria-labelledby="createAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createAccountModalLabel">Nuovo conto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createAccountForm">
            <div class="mb-3">
              <label for="accountName" class="form-label">Nome conto</label>
              <input type="text" class="form-control" id="accountName" required>
            </div>
            <div class="mb-3">
              <label for="accountType" class="form-label">Tipo conto</label>
              <input type="text" class="form-control" id="accountType" required>
            </div>
            <div class="mb-3">
              <label for="accountBalance" class="form-label">Disponibile iniziale</label>
              <input type="number" class="form-control" id="accountBalance" required>
            </div>
            <button type="submit" class="btn btn-primary">Aggiungi</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Account Modal -->
  <div class="modal fade" id="editAccountModal" tabindex="-1" aria-labelledby="editAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editAccountModalLabel">Modifica conto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editAccountForm">
            <input type="hidden" id="editAccountId">
            <div class="mb-3">
              <label for="editAccountName" class="form-label">Nome conto</label>
              <input type="text" class="form-control" id="editAccountName" required>
            </div>
            <div class="mb-3">
              <label for="editAccountType" class="form-label">Tipo conto</label>
              <input type="text" class="form-control" id="editAccountType">
            </div>
            <button type="submit" class="btn btn-primary">Modifica</button>
          </form>
        </div>
      </div>
    </div>
  </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="apiclient.js"></script>
    <script src="index.js"></script>
    <script>
        $(document).ready(async function () {
            await boot();
                
            // Initialize DataTable
            accountsTable = $("#accounts-page-table").DataTable({
                columns: [
                    { data: "id", visible: false},
                    { data: "name" },
                    { data: "balance" },
                    { data: "type" },
                    {
                    data: null,
                    orderable: false,
                    render: function (data, type, row) {
                        return `
                        <button class="btn btn-warning btn-sm edit-btn" data-id="${row.id}">Modifica</button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="${row.id}">Elimina</button>
                        `;
                    },
                    },
                ],
                paging: false,
                searching: false,
                info: false,
                ordering: false
            });

            // Load accounts into the DataTable
            async function loadAccounts() {
                try {
                    const accounts = await $.apiClient.listAccounts();
                    accountsTable.clear();
                    accounts.forEach(account => {
                        let total = $.accounts[account._id].total
                        if(!total) total = 0
                        accountsTable.row.add({
                            id: account._id,
                            name: account.name,
                            type: account.asset_type,
                            balance: total.toFixed(2)+" â‚¬"
                        });                    
                    });

                    accountsTable.draw();
                } catch (error) {
                    console.error("Error loading accounts:", error);
                }
            }

            
            // Initialize the page by loading accounts
            await loadAccounts();


            // Handle create account
            $("#createAccountForm").on("submit", async function (event) {
                event.preventDefault();
                const name = $("#accountName").val();
                const asset_type = $("#accountType").val();
                const balance = $("#accountBalance").val();

                try {
                    const res = await $.apiClient.addAccount({name, asset_type});
                    const inserted_id = res._id
                    const data = {
                        date: new Date(),
                        category: "Trasferimento",
                        amount: balance,
                        account: inserted_id,
                        description: `Apertura ${name}`
                    };
                    await $.apiClient.addTransaction(data)
                    $("#createAccountForm")[0].reset();
                    console.log("hiding modal")
                    $("#createAccountModal").modal("hide")

                } catch (error) {
                    console.error("Error creating account:", error);
                    $("#createAccountModal").modal("hide")
                }
                refreshAccounts().then(()=> loadAccounts())
            });

            // Handle edit button click
            $("#accounts-page-table").on("click", ".edit-btn", async function () {
                const id = $(this).data("id");
                console.log(`clicked edit on {id}`)
                const row = accountsTable.row($(this).closest("tr"));
                const rowData = row.data();
                $("#editAccountId").val(rowData.id);
                $("#editAccountName").val(rowData.name);
                $("#editAccountType").val(rowData.type);
                $("#editAccountModal").modal("show");
            });

            // Handle update account
            $("#editAccountForm").on("submit", async function (event) {
                event.preventDefault();
                const id = $("#editAccountId").val();
                const name = $("#editAccountName").val();
                const asset_type = $("#editAccountType").val();

                try {
                    await $.apiClient.updateAccount(id, { name, asset_type });
                    $("#editAccountModal").modal("hide");
                    await loadAccounts();
                } catch (error) {
                    console.error("Error updating account:", error);
                }
            });

            // Handle delete button click
            $("#accounts-page-table").on("click", ".delete-btn", async function () {
            const id = $(this).data("id");
            if (confirm("Sei sicuro di voler eliminare questo conto?")) {
                try {
                    await $.apiClient.deleteAccount(id);
                    refreshAccounts().then(()=> loadAccounts())
                } catch (error) {
                    console.error("Error deleting account:", error);
                }
            }
            });

        });
    </script>
</body>
</html>
